# Multi-Touch Attribution Model (MTA)

The **Multi-Touch Attribution (MTA)** model is a classic approach for evaluating the contribution of marketing channels to final sales. It assists marketing decision-makers in better allocating their resources, whether financial or personnel. Furthermore, the marketing team can calculate the return on investment (ROI) of their efforts by comparing the sales generated by each channel against the costs incurred.

There are several MTA (Multi-Touch Attribution) models, including *First Touch*, *Last Touch*, *Time-Decay*, *Position-Based*, *U-Shaped*, and *Data-Driven*, among others. Here, I am implementing one of the most popular attribution models, namely,***Time-Decay Attribition Model***.

## Table of Content

1.  [Import Moduels and Load Dataset](#import_moduel_load_data)
2.  [Data Wranggling](#data_wranggling)
3.  [Pause for a moment to verify that the dataframe is as expected](#verify_df)
4.  [Time-decay attribution model](#time_decay_attribution)
5.  [ROI Analysis](#roi)
6.  [Conclusion](#conclusion)

***

## <a id="import_moduel_load_data">Import Moduels and Load Dataset</a>


```python
import pandas as pd
import numpy as np
```


```python
# Load the interactions CSV file
interactions_df = pd.read_csv('fake_data/interactions.csv')

# Load the conversion CSV file
conversion_df = pd.read_csv('fake_data/conversion.csv')
```

<div class="alert alert-block alert-warning">
The dataset used in the following process is pseudo data.
</div>

## <a id='data_wranggling'>Data Wranggling</a>


```python
# Merge the two dataframe
merged_df = pd.merge(interactions_df, conversion_df, on='ConversionID', how='left')
merged_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InteractionID</th>
      <th>TimeStamp_x</th>
      <th>UserID</th>
      <th>SessionID</th>
      <th>Channel</th>
      <th>InteractionType</th>
      <th>ConversionID</th>
      <th>ConversionValue</th>
      <th>TimeStamp_y</th>
      <th>ProductID</th>
      <th>ProductUnit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2021-09-29</td>
      <td>2953</td>
      <td>0766e624-26f3-4976-a90b-528097821d3a</td>
      <td>Email</td>
      <td>Click</td>
      <td>1396.0</td>
      <td>2268.0</td>
      <td>2021-07-26</td>
      <td>145.0</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2</td>
      <td>2021-10-12</td>
      <td>3133</td>
      <td>7f1321a8-3e8e-470e-82df-0277e6f985c6</td>
      <td>Google Ads</td>
      <td>Click</td>
      <td>1477.0</td>
      <td>7570.0</td>
      <td>2021-04-20</td>
      <td>101.0</td>
      <td>15.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3</td>
      <td>2021-10-29</td>
      <td>1578</td>
      <td>d23e51b6-a878-4a2c-8168-f84277d2d6c1</td>
      <td>Other Referrals</td>
      <td>Click</td>
      <td>1073.0</td>
      <td>9873.0</td>
      <td>2021-08-27</td>
      <td>149.0</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>4</td>
      <td>2021-03-02</td>
      <td>3867</td>
      <td>d9d30af2-8c9e-4e2b-9399-692210619f5c</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>2309.0</td>
      <td>1986.0</td>
      <td>2021-01-08</td>
      <td>150.0</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>5</td>
      <td>2021-08-05</td>
      <td>224</td>
      <td>7383c643-6d05-4fe4-bc4d-6d4ab69bba72</td>
      <td>Email</td>
      <td>Click</td>
      <td>1891.0</td>
      <td>8040.0</td>
      <td>2021-06-01</td>
      <td>107.0</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table>
</div>




```python
# The Interaction that has a conversion should have the same timestamp

merged_df.loc[merged_df['ConversionID'].notna(), 'TimeStamp_y'] = merged_df['TimeStamp_x']
```


```python
# Identify users with conversions
users_with_conversion = merged_df[merged_df['ConversionID'].notna()]['UserID'].unique()

# Filter the DataFrame
converted_users_df = merged_df[merged_df['UserID'].isin(users_with_conversion)]

# Now, converted_users_df contains only data for users who have converted
```


```python
# Renaming columns in the DataFrame
converted_users_df = converted_users_df.rename(columns={
    'TimeStamp_x': 'TimeStamp_interaction',
    'TimeStamp_y': 'TimeStamp_conversion'
})
```


```python
# Assuming 'TimeStamp_interaction' and 'TimeStamp_conversion' columns are in your DataFrame

# Convert Timestamp columns to datetime
converted_users_df['TimeStamp_interaction'] = pd.to_datetime(converted_users_df['TimeStamp_interaction'])
converted_users_df['TimeStamp_conversion'] = pd.to_datetime(converted_users_df['TimeStamp_conversion'])

# Function to populate conversion timestamps for non-converted interactions
def populate_conversion_timestamps(group):
    group = group.sort_values('TimeStamp_interaction', ascending=False)
    
    # Forward fill to populate conversion timestamps for non-converted interactions
    group['TimeStamp_conversion'] = group['TimeStamp_conversion'].ffill()
    return group

# Apply the function to the DataFrame grouped by UserID
converted_users_df = converted_users_df.groupby('UserID').apply(populate_conversion_timestamps)

```


```python
# Calculate the time difference in days
converted_users_df['TimeDifference'] = (converted_users_df['TimeStamp_conversion'] - converted_users_df['TimeStamp_interaction']).dt.days

```


```python
# Filter out rows where the interaction timestamp is later than the conversion timestamp
filtered_df = converted_users_df[converted_users_df['TimeStamp_interaction'] <= converted_users_df['TimeStamp_conversion']]

```

## <a id='verify_df'>Pause for a moment to verify that the dataframe is as expected</a>

1) Each user might have several interaction sessions. At least one of interactions leads to a conversion.
2) The conversion interaction is the latest interaction of that user.


```python
# Reset the index of the DataFrame
filtered_df = filtered_df.reset_index(drop=True)
filtered_df
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InteractionID</th>
      <th>TimeStamp_interaction</th>
      <th>UserID</th>
      <th>SessionID</th>
      <th>Channel</th>
      <th>InteractionType</th>
      <th>ConversionID</th>
      <th>ConversionValue</th>
      <th>TimeStamp_conversion</th>
      <th>ProductID</th>
      <th>ProductUnit</th>
      <th>TimeDifference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1003</td>
      <td>2021-08-01</td>
      <td>3</td>
      <td>9c64ab66-f910-4b02-b2f8-60afd5e3c4ca</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>1610.0</td>
      <td>3795.0</td>
      <td>2021-08-01</td>
      <td>123.0</td>
      <td>15.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2309</td>
      <td>2021-02-18</td>
      <td>3</td>
      <td>f0b1aab9-d4ef-43ef-8ef1-19e4d54afdf9</td>
      <td>Google Ads</td>
      <td>Click</td>
      <td>1483.0</td>
      <td>3313.0</td>
      <td>2021-02-18</td>
      <td>112.0</td>
      <td>6.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16447</td>
      <td>2021-02-05</td>
      <td>3</td>
      <td>f34b69ac-3e14-4260-938b-118a7b9dee47</td>
      <td>Email</td>
      <td>Click</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-02-18</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>2021-10-30</td>
      <td>4</td>
      <td>b4f4d355-1792-466b-b25d-86bba8d9406f</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>2018.0</td>
      <td>508.0</td>
      <td>2021-10-30</td>
      <td>140.0</td>
      <td>13.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3978</td>
      <td>2021-06-16</td>
      <td>4</td>
      <td>fc963711-a525-4802-8802-7e2c8eca367c</td>
      <td>Other Referrals</td>
      <td>View</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-10-30</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>136.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>5939</th>
      <td>2078</td>
      <td>2021-05-29</td>
      <td>4998</td>
      <td>34ba85cf-ad0a-47f0-8b92-3e9fb47f830c</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>981.0</td>
      <td>5159.0</td>
      <td>2021-05-29</td>
      <td>136.0</td>
      <td>5.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5940</th>
      <td>2153</td>
      <td>2021-11-23</td>
      <td>4999</td>
      <td>e77102e1-494e-4a43-bd01-7e4a0e41cc2d</td>
      <td>Other Referrals</td>
      <td>Click</td>
      <td>815.0</td>
      <td>6901.0</td>
      <td>2021-11-23</td>
      <td>132.0</td>
      <td>13.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5941</th>
      <td>19316</td>
      <td>2021-10-29</td>
      <td>4999</td>
      <td>dcd1ed81-479a-49a7-803a-0dee71e5070b</td>
      <td>YouTube</td>
      <td>Click</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-11-23</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>25.0</td>
    </tr>
    <tr>
      <th>5942</th>
      <td>579</td>
      <td>2021-09-05</td>
      <td>4999</td>
      <td>be3586c5-50ff-44d2-9cc7-f5862ba8d736</td>
      <td>Other Referrals</td>
      <td>Click</td>
      <td>2051.0</td>
      <td>7174.0</td>
      <td>2021-09-05</td>
      <td>128.0</td>
      <td>19.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5943</th>
      <td>16496</td>
      <td>2021-06-01</td>
      <td>4999</td>
      <td>a27d33bc-de19-4455-9c17-b66795cd4305</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-09-05</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>96.0</td>
    </tr>
  </tbody>
</table>
<p>5944 rows Ã— 12 columns</p>
</div>




```python
# Test 1: Each user should have at least one interaction leading to a conversion
users_with_conversion = filtered_df.groupby('UserID')['ConversionID'].apply(lambda x: x.notna().any())

# Use all() function to test if there's any False in the output
users_with_conversion.all()
```




    True




```python
# Test 2: The latest interaction for each user should be a conversion

def check_latest_interaction(group):
    latest_interaction = group.sort_values('TimeStamp_interaction', ascending=False).iloc[0]
    return pd.notna(latest_interaction['ConversionID'])

latest_interaction_is_conversion = filtered_df.groupby('UserID').apply(check_latest_interaction)

# Test if there's any Flase in the output
latest_interaction_is_conversion.all()
```




    True



## <a id='time_decay_attribution'>Time-decay attribution model</a>

**Time-Decay Attribition Model** usually use this following calculation as decay factor: **weight = 0.5(t/half-life)**. In this model, **'t'** represents the time difference between a touchpoint and the final conversion. The **'half-life'** is typically set to 7, indicating that the influence on conversion is halved every seven days.


```python
# Define the half-life period in days
half_life = 7

# Apply the exponential time-decay formula
filtered_df['DecayWeight'] = 0.5 ** (filtered_df['TimeDifference'] / half_life)

# Display the first few rows to verify the decay weight calculation
filtered_df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InteractionID</th>
      <th>TimeStamp_interaction</th>
      <th>UserID</th>
      <th>SessionID</th>
      <th>Channel</th>
      <th>InteractionType</th>
      <th>ConversionID</th>
      <th>ConversionValue</th>
      <th>TimeStamp_conversion</th>
      <th>ProductID</th>
      <th>ProductUnit</th>
      <th>TimeDifference</th>
      <th>DecayWeight</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1003</td>
      <td>2021-08-01</td>
      <td>3</td>
      <td>9c64ab66-f910-4b02-b2f8-60afd5e3c4ca</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>1610.0</td>
      <td>3795.0</td>
      <td>2021-08-01</td>
      <td>123.0</td>
      <td>15.0</td>
      <td>0.0</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2309</td>
      <td>2021-02-18</td>
      <td>3</td>
      <td>f0b1aab9-d4ef-43ef-8ef1-19e4d54afdf9</td>
      <td>Google Ads</td>
      <td>Click</td>
      <td>1483.0</td>
      <td>3313.0</td>
      <td>2021-02-18</td>
      <td>112.0</td>
      <td>6.0</td>
      <td>0.0</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>16447</td>
      <td>2021-02-05</td>
      <td>3</td>
      <td>f34b69ac-3e14-4260-938b-118a7b9dee47</td>
      <td>Email</td>
      <td>Click</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-02-18</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>13.0</td>
      <td>0.276022</td>
    </tr>
    <tr>
      <th>3</th>
      <td>764</td>
      <td>2021-10-30</td>
      <td>4</td>
      <td>b4f4d355-1792-466b-b25d-86bba8d9406f</td>
      <td>Instagram</td>
      <td>Click</td>
      <td>2018.0</td>
      <td>508.0</td>
      <td>2021-10-30</td>
      <td>140.0</td>
      <td>13.0</td>
      <td>0.0</td>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3978</td>
      <td>2021-06-16</td>
      <td>4</td>
      <td>fc963711-a525-4802-8802-7e2c8eca367c</td>
      <td>Other Referrals</td>
      <td>View</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2021-10-30</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>136.0</td>
      <td>0.000001</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Normalize the decay weights within each user's journey
filtered_df['NormalizedDecayWeight'] = filtered_df.groupby('UserID')['DecayWeight'].transform(lambda x: x / x.sum())
```


```python
# Aggregate the normalized weights for each touchpoint across all users
channel_attribution = filtered_df.groupby('Channel')['NormalizedDecayWeight'].sum()
```


```python
# Sort and display the results to understand channel effectiveness
channel_attribution_sorted = pd.DataFrame(channel_attribution.sort_values(ascending=False))

channel_attribution_sorted['Percentage'] = channel_attribution_sorted['NormalizedDecayWeight']/channel_attribution_sorted['NormalizedDecayWeight'].sum()
```


```python
# Calculate the contribution in revenue, in absolute numbers
totalrevenue = filtered_df['ConversionValue'].sum()
channel_attribution_sorted['RevenueContribution'] = channel_attribution_sorted['Percentage']*totalrevenue
```


```python
channel_attribution_sorted
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NormalizedDecayWeight</th>
      <th>Percentage</th>
      <th>RevenueContribution</th>
    </tr>
    <tr>
      <th>Channel</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Instagram</th>
      <td>283.079387</td>
      <td>0.150175</td>
      <td>1.785745e+06</td>
    </tr>
    <tr>
      <th>Google Ads</th>
      <td>275.060680</td>
      <td>0.145921</td>
      <td>1.735161e+06</td>
    </tr>
    <tr>
      <th>YouTube</th>
      <td>273.786678</td>
      <td>0.145245</td>
      <td>1.727124e+06</td>
    </tr>
    <tr>
      <th>Google Search</th>
      <td>271.355545</td>
      <td>0.143955</td>
      <td>1.711788e+06</td>
    </tr>
    <tr>
      <th>Other Referrals</th>
      <td>267.496676</td>
      <td>0.141908</td>
      <td>1.687445e+06</td>
    </tr>
    <tr>
      <th>Email</th>
      <td>260.449759</td>
      <td>0.138170</td>
      <td>1.642991e+06</td>
    </tr>
    <tr>
      <th>Facebook</th>
      <td>253.771274</td>
      <td>0.134627</td>
      <td>1.600861e+06</td>
    </tr>
  </tbody>
</table>
</div>



## <a id='roi'>ROI Analysis</a>

As we have obtained the revenue contribution in absolute numbers, we can compare these figures with the costs incurred to calculate the Return on Investment (ROI). This is beneficial for decision-makers when allocating funds and staff.


```python
# Load the cost data and aggregate the campaign cost
campaign_df = pd.read_csv('fake_data/campaign_data.csv')
channel_attribution_sorted['CampaignCost'] = campaign_df.groupby('Channel')['Cost'].sum()

# Caluclate the ROI
channel_attribution_sorted['ROI'] = (channel_attribution_sorted['RevenueContribution']- channel_attribution_sorted['CampaignCost'])/ channel_attribution_sorted['CampaignCost']
```


```python
channel_attribution_sorted
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>NormalizedDecayWeight</th>
      <th>Percentage</th>
      <th>RevenueContribution</th>
      <th>CampaignCost</th>
      <th>ROI</th>
    </tr>
    <tr>
      <th>Channel</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Instagram</th>
      <td>283.079387</td>
      <td>0.150175</td>
      <td>1.785745e+06</td>
      <td>38000</td>
      <td>45.993289</td>
    </tr>
    <tr>
      <th>Google Ads</th>
      <td>275.060680</td>
      <td>0.145921</td>
      <td>1.735161e+06</td>
      <td>35411</td>
      <td>48.000613</td>
    </tr>
    <tr>
      <th>YouTube</th>
      <td>273.786678</td>
      <td>0.145245</td>
      <td>1.727124e+06</td>
      <td>39352</td>
      <td>42.889102</td>
    </tr>
    <tr>
      <th>Google Search</th>
      <td>271.355545</td>
      <td>0.143955</td>
      <td>1.711788e+06</td>
      <td>35875</td>
      <td>46.715335</td>
    </tr>
    <tr>
      <th>Other Referrals</th>
      <td>267.496676</td>
      <td>0.141908</td>
      <td>1.687445e+06</td>
      <td>31937</td>
      <td>51.836673</td>
    </tr>
    <tr>
      <th>Email</th>
      <td>260.449759</td>
      <td>0.138170</td>
      <td>1.642991e+06</td>
      <td>6887</td>
      <td>237.564086</td>
    </tr>
    <tr>
      <th>Facebook</th>
      <td>253.771274</td>
      <td>0.134627</td>
      <td>1.600861e+06</td>
      <td>42967</td>
      <td>36.257921</td>
    </tr>
  </tbody>
</table>
</div>



### <a id='conclusion'>Conclusion</a>

Based on the results, we can see that Instagram contributed the most to final sales, followed by Google Ads and YouTube. However, in terms of ROI, Emails and other referrals yielded significantly higher returns. Given these findings, the marketing team can devise a hybrid strategy, tailoring different campaign strategies to meet specific needs.
